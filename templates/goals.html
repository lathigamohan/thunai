{% extends "base.html" %}

{% block title %}Savings Goals - Finla{% endblock %}

{% block content %}
<div class="row">
    <!-- Add Goal Form -->
    <div class="col-md-6 mb-4">
        <div class="card bg-dark gold-border">
            <div class="card-body">
                <h3 class="card-title gold-text">
                    <i class="fas fa-bullseye me-2"></i>Set New Goal
                </h3>
                
                <form method="POST">
                    <div class="mb-3">
                        <label for="goal_name" class="form-label gold-text">Goal Name</label>
                        <input type="text" class="form-control bg-dark text-white gold-border" 
                               id="goal_name" name="goal_name" required
                               placeholder="e.g., New Laptop, Vacation, Emergency Fund">
                    </div>
                    
                    <div class="mb-3">
                        <label for="target_amount" class="form-label gold-text">Target Amount (₹)</label>
                        <input type="number" class="form-control bg-dark text-white gold-border" 
                               id="target_amount" name="target_amount" step="0.01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="target_date" class="form-label gold-text">Target Date</label>
                        <input type="date" class="form-control bg-dark text-white gold-border" 
                               id="target_date" name="target_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="current_amount" class="form-label gold-text">Current Amount (₹)</label>
                        <input type="number" class="form-control bg-dark text-white gold-border" 
                               id="current_amount" name="current_amount" step="0.01" value="0">
                    </div>
                    
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="fas fa-plus me-2"></i>Create Goal
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Goal Statistics -->
    <div class="col-md-6 mb-4">
        <div class="card bg-dark gold-border">
            <div class="card-body">
                <h3 class="card-title gold-text">
                    <i class="fas fa-chart-line me-2"></i>Goal Statistics
                </h3>
                
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="gold-text">{{ goals|length }}</h4>
                        <p class="text-muted">Active Goals</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="gold-text">
                            {% set completed_goals = goals|selectattr('current_amount', 'ge', goals|map(attribute='target_amount'))|list %}
                            {{ completed_goals|length }}
                        </h4>
                        <p class="text-muted">Completed</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="gold-text">
                            ₹{{ "%.0f"|format(goals|sum(attribute='target_amount')) }}
                        </h4>
                        <p class="text-muted">Total Target</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="gold-text">
                            ₹{{ "%.0f"|format(goals|sum(attribute='current_amount')) }}
                        </h4>
                        <p class="text-muted">Total Saved</p>
                    </div>
                </div>
                
                <!-- Overall Progress -->
                <div class="mt-3">
                    <h6 class="gold-text">Overall Progress</h6>
                    {% set total_target = goals|sum(attribute='target_amount') %}
                    {% set total_saved = goals|sum(attribute='current_amount') %}
                    {% set overall_progress = (total_saved / total_target * 100) if total_target > 0 else 0 %}
                    <div class="progress gold-progress">
                        <div class="progress-bar bg-warning" style="width: {{ overall_progress }}%"></div>
                    </div>
                    <small class="text-muted">{{ "%.1f"|format(overall_progress) }}% of all goals</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Goals List -->
    <div class="col-12">
        <div class="card bg-dark gold-border">
            <div class="card-body">
                <h3 class="card-title gold-text">
                    <i class="fas fa-list me-2"></i>Your Savings Goals
                </h3>
                
                {% if goals %}
                    <div class="row">
                        {% for goal in goals %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="goal-card p-3 rounded gold-border h-100">
                                <!-- Goal Header -->
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="gold-text mb-0">{{ goal.name }}</h5>
                                    {% set progress_percentage = (goal.current_amount / goal.target_amount * 100) if goal.target_amount > 0 else 0 %}
                                    {% if progress_percentage >= 100 %}
                                        <i class="fas fa-trophy text-warning fs-4" title="Goal Completed!"></i>
                                    {% elif progress_percentage >= 75 %}
                                        <i class="fas fa-medal text-warning" title="Almost There!"></i>
                                    {% else %}
                                        <i class="fas fa-target gold-text"></i>
                                    {% endif %}
                                </div>
                                
                                <!-- Goal Progress -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>₹{{ "%.0f"|format(goal.current_amount) }}</span>
                                        <span>₹{{ "%.0f"|format(goal.target_amount) }}</span>
                                    </div>
                                    <div class="progress gold-progress">
                                        <div class="progress-bar {% if progress_percentage >= 100 %}bg-success{% elif progress_percentage >= 75 %}bg-warning{% else %}bg-info{% endif %}" 
                                             style="width: {{ progress_percentage if progress_percentage <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format(progress_percentage) }}% complete</small>
                                </div>
                                
                                <!-- Goal Details -->
                                <div class="goal-details">
                                    <p class="mb-1"><i class="fas fa-calendar me-2 gold-text"></i>Target: {{ goal.target_date }}</p>
                                    <p class="mb-1"><i class="fas fa-plus me-2 gold-text"></i>Created: {{ goal.created_date }}</p>
                                    
                                    {% set remaining_amount = goal.target_amount - goal.current_amount %}
                                    {% if remaining_amount > 0 %}
                                        <p class="mb-1"><i class="fas fa-piggy-bank me-2 gold-text"></i>Remaining: ₹{{ "%.0f"|format(remaining_amount) }}</p>
                                        
                                        <!-- Calculate daily savings needed -->
                                        {% set target_date = goal.target_date %}
                                        {% set days_remaining = ((target_date|string + ' 00:00:00')|strptime('%Y-%m-%d %H:%M:%S') - moment()).days %}
                                        {% if days_remaining > 0 %}
                                            {% set daily_needed = remaining_amount / days_remaining %}
                                            <p class="mb-0"><i class="fas fa-calendar-day me-2 gold-text"></i>Save ₹{{ "%.0f"|format(daily_needed) }}/day</p>
                                        {% endif %}
                                    {% else %}
                                        <p class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i>Goal Achieved!</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Goal Actions -->
                                <div class="mt-3">
                                    <button class="btn btn-outline-warning btn-sm me-2" onclick="updateGoal({{ goal.id }})">
                                        <i class="fas fa-edit me-1"></i>Update
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteGoal({{ goal.id }})">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-bullseye fs-1 mb-3"></i>
                        <h4>No Savings Goals Yet</h4>
                        <p>Set your first savings goal to start tracking your financial progress!</p>
                        <button class="btn btn-warning" onclick="document.getElementById('goal_name').focus()">
                            <i class="fas fa-plus me-2"></i>Create Your First Goal
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Goal Tips -->
    <div class="col-12 mt-4">
        <div class="card bg-dark gold-border">
            <div class="card-body">
                <h5 class="card-title gold-text">
                    <i class="fas fa-lightbulb me-2"></i>Goal Setting Tips
                </h5>
                
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-flag-checkered gold-text fs-2 mb-2"></i>
                        <h6 class="gold-text">Be Specific</h6>
                        <small class="text-muted">Set clear, specific goals with exact amounts and deadlines.</small>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-chart-line gold-text fs-2 mb-2"></i>
                        <h6 class="gold-text">Track Progress</h6>
                        <small class="text-muted">Regularly update your progress to stay motivated.</small>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-clock gold-text fs-2 mb-2"></i>
                        <h6 class="gold-text">Set Deadlines</h6>
                        <small class="text-muted">Having a timeline creates urgency and focus.</small>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="fas fa-trophy gold-text fs-2 mb-2"></i>
                        <h6 class="gold-text">Celebrate Wins</h6>
                        <small class="text-muted">Acknowledge when you reach milestones and goals.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Goal Modal -->
<div class="modal fade" id="updateGoalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark gold-border">
            <div class="modal-header">
                <h5 class="modal-title gold-text">Update Goal</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateGoalForm">
                    <div class="mb-3">
                        <label for="update_current_amount" class="form-label gold-text">Current Amount (₹)</label>
                        <input type="number" class="form-control bg-dark text-white gold-border" 
                               id="update_current_amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="update_note" class="form-label gold-text">Note (Optional)</label>
                        <textarea class="form-control bg-dark text-white gold-border" 
                                  id="update_note" rows="2" placeholder="Add a note about this update..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="saveGoalUpdate()">Save Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentGoalId = null;

// Set minimum date to today
document.getElementById('target_date').min = new Date().toISOString().split('T')[0];

// Goal management functions
function updateGoal(goalId) {
    currentGoalId = goalId;
    // Find the goal and populate the modal
    const goalCard = event.target.closest('.goal-card');
    const currentAmount = goalCard.querySelector('.progress').previousElementSibling.children[0].textContent.replace('₹', '').replace(',', '');
    
    document.getElementById('update_current_amount').value = currentAmount;
    
    const modal = new bootstrap.Modal(document.getElementById('updateGoalModal'));
    modal.show();
}

function saveGoalUpdate() {
    const currentAmount = document.getElementById('update_current_amount').value;
    const note = document.getElementById('update_note').value;
    
    // Here you would typically send an AJAX request to update the goal
    // For now, we'll just show a success message and reload
    alert('Goal updated successfully!');
    location.reload();
}

function deleteGoal(goalId) {
    if (confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
        // Here you would typically send an AJAX request to delete the goal
        // For now, we'll just show a message
        alert('Goal deleted successfully!');
        location.reload();
    }
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const targetDate = new Date(document.getElementById('target_date').value);
    const today = new Date();
    
    if (targetDate <= today) {
        e.preventDefault();
        alert('Target date must be in the future');
        return;
    }
    
    const targetAmount = parseFloat(document.getElementById('target_amount').value);
    const currentAmount = parseFloat(document.getElementById('current_amount').value);
    
    if (currentAmount > targetAmount) {
        e.preventDefault();
        alert('Current amount cannot be greater than target amount');
        return;
    }
});

// Auto-calculate daily savings needed
document.getElementById('target_date').addEventListener('change', function() {
    const targetAmount = parseFloat(document.getElementById('target_amount').value);
    const currentAmount = parseFloat(document.getElementById('current_amount').value) || 0;
    const targetDate = new Date(this.value);
    const today = new Date();
    
    if (targetAmount && targetDate > today) {
        const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        const remainingAmount = targetAmount - currentAmount;
        const dailyNeeded = remainingAmount / daysRemaining;
        
        if (dailyNeeded > 0) {
            // You could show this information near the form
            console.log(`Need to save ₹${dailyNeeded.toFixed(0)} per day`);
        }
    }
});

// Goal suggestions
const goalSuggestions = [
    { name: 'Emergency Fund', amount: 50000 },
    { name: 'New Smartphone', amount: 25000 },
    { name: 'Laptop Upgrade', amount: 60000 },
    { name: 'Vacation Trip', amount: 30000 },
    { name: 'Wedding Fund', amount: 200000 },
    { name: 'Car Down Payment', amount: 100000 },
    { name: 'Home Down Payment', amount: 500000 },
    { name: 'Education Course', amount: 15000 }
];

document.getElementById('goal_name').addEventListener('input', function() {
    const input = this.value.toLowerCase();
    const matchingGoal = goalSuggestions.find(goal => 
        goal.name.toLowerCase().includes(input)
    );
    
    if (matchingGoal && input.length > 2) {
        document.getElementById('target_amount').value = matchingGoal.amount;
    }
});
</script>
{% endblock %}
